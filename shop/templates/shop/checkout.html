{% extends 'base.html' %}
{% block content %}
<h1 class="checkout-title">Checkout</h1>
<div id="checkout-summary"></div>
<form id="checkout-form" class="checkout-form">
    <label>
        Shipping Address<br>
        <input type="text" name="address" required value="{{ customer.address|default_if_none:'' }}">
    </label>
    <label>
        Phone Number<br>
        <input type="text" name="phone" required value="{{ customer.phone }}">
    </label>
    <button type="submit">Place Order</button>
    <div id="checkout-message"></div>
</form>
<script>
fetch('/shop/api/customers/{{ request.user.customer.id }}/cart/')
    .then(response => response.json())
    .then(products => {
        let total = products.reduce((sum, p) => sum + p.price * (p.quantity || 1), 0);
        document.getElementById('checkout-summary').innerHTML = `
            <h3>Order Summary</h3>
            <ul>
                ${products.map(p => `<li>${p.name} x${p.quantity || 1} <span style="float:right;">${p.price * (p.quantity || 1)} KZT</span></li>`).join('')}
            </ul>
            <div class="order-total">Total: <span>${total} KZT</span></div>
        `;
    });

document.getElementById('checkout-form').onsubmit = function(e) {
    e.preventDefault();
    const address = this.address.value;
    const phone = this.phone.value;
    fetch('/shop/api/customers/{{ request.user.customer.id }}/checkout/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({address: address, phone: phone})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.href = "{% url 'orders' %}";
        } else {
            document.getElementById('checkout-message').textContent = data.message || 'Error placing order.';
        }
    });
};
</script>
{% endblock %}