{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h1>Your Cart</h1>
    <form id="cart-form" onsubmit="return false;">
        <div class="products" id="cart-list"></div>
        <div id="cart-summary" style="margin-top:20px; font-weight:bold;"></div>
        <button type="button" id="checkout-btn" style="margin-top:20px;">Checkout</button>
    </form>
</div>
<script>
function renderCart(products) {
    let total = 0;
    document.getElementById('cart-list').innerHTML = products.map(product => {
        total += product.price * (product.quantity || 1);
        return `
            <div class="product cart-item" data-product="${product.id}">
                <a href="/shop/product/${product.id}/" class="product-link" style="text-decoration:none;color:inherit;">
                    <img src="${product.image}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p>Price: ${product.price} KZT</p>
                </a>
                <div class="product-actions">
                    <div class="quantity-control">
                        <button class="qty-minus" data-product="${product.id}" type="button">-</button>
                        <span class="qty-value" id="qty-${product.id}">${product.quantity || 1}</span>
                        <button class="qty-plus" data-product="${product.id}" type="button">+</button>
                    </div>
                    <button class="remove-btn" data-product="${product.id}" type="button">Remove</button>
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('cart-summary').textContent = "Total: " + total + " KZT";
}

function fetchCart() {
    fetch('/shop/api/customers/{{ request.user.customer.id }}/cart/')
        .then(response => response.json())
        .then(products => {
            if (products.length === 0) {
                document.getElementById('cart-list').innerHTML = '<p>Your cart is empty.</p>';
                document.getElementById('cart-summary').textContent = '';
            } else {
                renderCart(products);
            }
        });
}

fetchCart();

// Event delegation for quantity and remove buttons
document.getElementById('cart-list').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-btn')) {
        e.preventDefault();
        const productId = e.target.getAttribute('data-product');
        fetch(`/shop/api/customers/{{ request.user.customer.id }}/remove_from_cart/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({product_id: productId})
        })
        .then(response => response.json())
        .then(() => {
            fetchCart();
        });
    }
    if (e.target.classList.contains('qty-plus') || e.target.classList.contains('qty-minus')) {
        e.preventDefault();
        const productId = e.target.getAttribute('data-product');
        let qtySpan = document.getElementById('qty-' + productId);
        let currentQty = parseInt(qtySpan.textContent);
        let newQty = e.target.classList.contains('qty-plus') ? currentQty + 1 : Math.max(1, currentQty - 1);
        fetch(`/shop/api/customers/{{ request.user.customer.id }}/update_cart_quantity/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({product_id: productId, quantity: newQty})
        }).then(() => {
            fetchCart();
        });
    }
});

document.getElementById('checkout-btn').onclick = function() {
    window.location.href = "{% url 'checkout' %}";
};
</script>

<div class="pagination" style="text-align:center; margin:2rem 0;">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
    {% endif %}
    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Next</a>
    {% endif %}
</div>
{% endblock %}