{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>Latest Products</h1>
    <div class="products">
        {% for product in products %}
            <a href="{% url 'product' product.id %}" class="product">
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                <h3>{{ product.name }}</h3>
                <p>Price: {{ product.price }} KZT</p>
                <div class="product-actions">
                    <button class="fav-btn" data-product="{{ product.id }}">
                        {% if product.id in favourites %}
                            &#10084;&#65039; <!-- filled heart -->
                        {% else %}
                            &#9825; <!-- empty heart -->
                        {% endif %}
                    </button>
                    <button class="cart-btn" data-product="{{ product.id }}">
                        {% if product.id in cart_products %}
                            <span style="opacity:0.7;">&#128722;</span> <!-- faded cart -->
                        {% else %}
                            &#128722; <!-- normal cart -->
                        {% endif %}
                    </button>
                </div>
            </a>
        {% endfor %}
    </div>
</div>
<script>
document.querySelectorAll('.product').forEach(card => {
    const productId = card.querySelector('.fav-btn').getAttribute('data-product');
    let isFavourited = card.querySelector('.fav-btn').innerHTML.includes('&#10084;');
    let isInCart = card.querySelector('.cart-btn').innerHTML.includes('opacity');

    const favBtn = card.querySelector('.fav-btn');
    const cartBtn = card.querySelector('.cart-btn');

    function updateFavButton() {
        favBtn.innerHTML = isFavourited ? '&#10084;&#65039;' : '&#9825;';
    }

    function updateCartButton() {
        cartBtn.innerHTML = isInCart ? '<span style="opacity:0.7;">&#128722;</span>' : '&#128722;';
    }

    const isAuthenticated = {{ is_authenticated|yesno:"true,false" }};

    favBtn.onclick = function(e) {
        e.preventDefault();
        if (!isAuthenticated) {
            window.location.href = "{% url 'login' %}?next=" + window.location.pathname;
            return;
        }
        const url = isFavourited
            ? `/shop/api/customers/{{ request.user.customer.id }}/remove_favourite/`
            : `/shop/api/customers/{{ request.user.customer.id }}/add_favourite/`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({product_id: productId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'added') {
                isFavourited = true;
                updateFavButton();
            } else if (data.status === 'removed') {
                isFavourited = false;
                updateFavButton();
            } else {
                favBtn.innerHTML = 'Error';
            }
        })
        .catch(() => {
            favBtn.innerHTML = 'Error';
        });
    };

    cartBtn.onclick = function(e) {
        e.preventDefault();
        if (!isAuthenticated) {
            window.location.href = "{% url 'login' %}?next=" + window.location.pathname;
            return;
        }
        const url = isInCart
            ? `/shop/api/customers/{{ request.user.customer.id }}/remove_from_cart/`
            : `/shop/api/customers/{{ request.user.customer.id }}/add_to_cart/`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({product_id: productId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'added') {
                isInCart = true;
                updateCartButton();
            } else if (data.status === 'removed') {
                isInCart = false;
                updateCartButton();
            } else {
                cartBtn.innerHTML = 'Error';
            }
        })
        .catch(() => {
            cartBtn.innerHTML = 'Error';
        });
    };
});
</script>
{% endblock %}